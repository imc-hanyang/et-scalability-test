{% extends 'base.html' %}
{% block content %}
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/materialize/1.0.0-beta/css/materialize.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/materialize/1.0.0-beta/js/materialize.min.js"></script>
    
    <!-- Login Form -->
    <div class="col s12 m6 offset-m3 center-align">
        <div class="card" style="padding: 20px; max-width: 400px; margin: 0 auto;">
            <form method="POST" action="{% url 'login' %}">
                {% csrf_token %}
                {% if error %}
                    <p style="color: red;">{{ error }}</p>
                {% endif %}
                <div class="input-field">
                    <input type="text" id="username" name="username" required>
                    <label for="username">Username</label>
                </div>
                <div class="input-field">
                    <input type="password" id="password" name="password" required>
                    <label for="password">Password</label>
                </div>
                <button type="submit" class="btn waves-effect waves-light" style="width: 100%;">
                    Login
                </button>
            </form>
            <p style="margin-top: 15px;">
                Don't you have your account? <a href="{% url 'register' %}">Sign Up</a>
            </p>
        </div>
    </div>

    <!-- Dev Login (for development) -->
{#    {% load static %}#}
{#    <div class="col s12 m6 offset-m3 center-align" style="margin-top: 20px">#}
{#        <a class="oauth-container btn darken-4 white black-text" href="{% url 'dev-login' %}" style="text-transform:none">#}
{#            <div class="left">#}
{#                <img width="20px" style="margin-top:7px; margin-right:8px" alt="Google sign-in" src="{% static 'google_logo.svg' %}"/>#}
{#            </div>#}
{#            Development login (dev@easytrack.com)#}
{#        </a>#}
{#    </div>#}

    <script>
        let gAuth; // Google Auth object.

        $(document).init(function () {
            $('#loginButton').click(function () {
                gapi.load('auth2', function () {
                    gapi.auth2.authorize({
                        client_id: '79296265957-khvficocpqmhajv3c5obiljo2k95jqt3.apps.googleusercontent.com',
                        scope: "email profile openid",
                        response_type: 'id_token permission'
                    }, function (response) {
                        if (response.error) {
                            alert('Failed to login, please try again!')
                            return;
                        }

                        let idToken = response.id_token;
                        let redirectUrl = `${location.protocol}//${location.host}{% url 'login' %}?idToken=${idToken}`;
                        console.log(`redirectUrl: ${redirectUrl}`);
                        window.location.replace(redirectUrl);
                    });
                });
            });
        });

        function initGoogleApiClient() {
            gapi.client.init({
                'apiKey': 'AIzaSyC0RSyYQIVC0palvzQQ5YUEW6g1taUT2VY',
                'clientId': '79296265957-khvficocpqmhajv3c5obiljo2k95jqt3.apps.googleusercontent.com',
                'scope': "https://www.googleapis.com/auth/userinfo.email https://www.googleapis.com/auth/userinfo.profile openid",
            }).then(function () {
                gAuth = gapi.auth2.getAuthInstance();
                gAuth.isSignedIn.listen(updateSigninStatus);
            });
        }

        function updateSigninStatus(isSignedIn) {
            console.log('updateSigninStatus');
            if (isSignedIn) {
                // todo redirect here

                let user = gAuth.currentUser;
                console.log(`user: ${user}`);

                let resp = user.getAuthResponse();
                console.log(`resp: ${resp}`);

                let idToken = resp.id_token;
                console.log(`idToken: ${idToken}`);
            }
        }
    </script>

    <style>
        body {
            text-align: center;
        }
    </style>
{% endblock %}
